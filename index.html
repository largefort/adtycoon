<html><head><base href="/" />
<meta charset="UTF-8" />
<title>Ad Tycoon - Force Them to Watch!</title>
<style>
    /* Add new loading screen styles */
    #loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        transition: opacity 0.5s;
    }

    #loading-screen.hidden {
        opacity: 0;
        pointer-events: none;
    }

    .loading-tv {
        width: 300px;
        height: 200px;
        background: #000;
        border: 20px solid #2a2a2a;
        border-radius: 15px;
        margin-bottom: 30px;
        position: relative;
        overflow: hidden;
        box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
    }

    .loading-tv::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: repeating-linear-gradient(
            0deg,
            rgba(0, 0, 0, 0.1),
            rgba(0, 0, 0, 0.1) 2px,
            transparent 2px,
            transparent 4px
        );
        animation: scanline 10s linear infinite;
    }

    .loading-text {
        color: #00ff9d;
        font-size: 24px;
        margin-bottom: 20px;
        text-shadow: 0 0 10px rgba(0, 255, 157, 0.3);
    }

    #loading-progress {
        width: 300px;
        height: 30px;
        background: rgba(255, 0, 0, 0.1);
        border-radius: 15px;
        overflow: hidden;
        box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.5);
        position: relative;
    }

    #loading-meter {
        height: 100%;
        background: linear-gradient(90deg, 
            #ff4d4d,
            #ff0000 50%,
            #cc0000 100%
        );
        width: 0%;
        transition: 0.3s;
        box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
        position: relative;
    }

    #loading-meter::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
            90deg,
            transparent 0%,
            rgba(255, 255, 255, 0.2) 50%,
            transparent 100%
        );
        animation: rageGlow 2s ease-in-out infinite;
    }

    /* Hide the original game container initially */
    .game-container {
        display: none;
    }

    .game-container.visible {
        display: block;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        color: #e4e4e4;
        margin: 0;
        padding: 20px;
        user-select: none;
        min-height: 100vh;
    }

    .game-container {
        max-width: 900px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.05);
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
    }

    h1 {
        text-align: center;
        font-size: 2.5em;
        margin-bottom: 30px;
        color: #00ff9d;
        text-shadow: 0 0 10px rgba(0, 255, 157, 0.3);
    }

    .tv-screen {
        width: 500px;
        height: 350px;
        background: linear-gradient(to bottom, #000000, #1a1a1a);
        border: 35px solid #2a2a2a;
        border-radius: 20px;
        margin: 30px auto;
        position: relative;
        overflow: hidden;
        box-shadow: 0 0 50px rgba(0, 0, 0, 0.5),
                    inset 0 0 20px rgba(0, 0, 0, 0.8);
        transform: perspective(1000px) rotateX(5deg);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .tv-screen::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: repeating-linear-gradient(
            0deg,
            rgba(0, 0, 0, 0.1),
            rgba(0, 0, 0, 0.1) 2px,
            transparent 2px,
            transparent 4px
        );
        pointer-events: none;
        animation: scanline 10s linear infinite;
    }

    @keyframes scanline {
        0% { transform: translateY(0); }
        100% { transform: translateY(350px); }
    }

    .tv-screen::after {
        content: '';
        position: absolute;
        top: -35px;
        right: -35px;
        width: 70px;
        height: 70px;
        background: #1a1a1a;
        border-radius: 10px;
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
    }

    .ad {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80%;
        font-size: 32px;
        color: #fff;
        text-align: center;
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        padding: 20px;
        background: rgba(0, 0, 0, 0.7);
        border-radius: 10px;
        animation: adTransition 0.5s;
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    @keyframes adTransition {
        0% { 
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.8) rotate(-2deg);
        }
        50% {
            transform: translate(-50%, -50%) scale(1.1) rotate(1deg);
        }
        100% { 
            opacity: 1;
            transform: translate(-50%, -50%) scale(1) rotate(0deg);
        }
    }

    .controls {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 25px;
        margin: 40px 0;
        padding: 20px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .upgrade {
        background: linear-gradient(165deg, #2a2a4a 0%, #1a2a3e 100%);
        padding: 25px;
        border-radius: 18px;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        border: 2px solid rgba(255, 255, 255, 0.05);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        position: relative;
        overflow: hidden;
    }

    .upgrade:before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
            90deg,
            transparent,
            rgba(255, 255, 255, 0.1),
            transparent
        );
        transition: 0.5s;
    }

    .upgrade:hover:before {
        left: 100%;
    }

    .upgrade:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
        border-color: rgba(0, 255, 157, 0.3);
    }

    .upgrade:active {
        transform: translateY(-2px) scale(0.98);
    }

    .upgrade small {
        display: block;
        margin-top: 12px;
        opacity: 0.8;
        font-size: 0.9em;
        color: #a0a0a0;
        transition: color 0.3s ease;
    }

    .upgrade:hover small {
        color: #00ff9d;
    }

    .disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none !important;
        border-color: rgba(255, 0, 0, 0.2);
    }

    .disabled:hover {
        transform: none !important;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        border-color: rgba(255, 0, 0, 0.2);
    }

    .free-upgrade {
        background: linear-gradient(165deg, #006633 0%, #004d26 100%);
        border-color: rgba(0, 255, 157, 0.2);
    }

    .free-upgrade:hover {
        background: linear-gradient(165deg, #00773b 0%, #005c2f 100%);
        border-color: rgba(0, 255, 157, 0.4);
    }

    .upgrade::after {
        content: attr(data-cost);
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.3);
        padding: 5px 10px;
        border-radius: 10px;
        font-size: 0.8em;
        color: #00ff9d;
        border: 1px solid rgba(0, 255, 157, 0.2);
    }

    .stats {
        background: rgba(0, 0, 0, 0.3);
        padding: 25px;
        border-radius: 15px;
        margin-bottom: 30px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .stats h2, .stats h3 {
        margin: 10px 0;
        color: #00ff9d;
    }

    #viewer-rage {
        width: 100%;
        height: 30px;
        background: rgba(255, 0, 0, 0.1);
        margin: 15px 0;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.5);
        position: relative;
    }

    #rage-meter {
        height: 100%;
        background: linear-gradient(90deg, 
            #ff4d4d,
            #ff0000 50%,
            #cc0000 100%
        );
        width: 0%;
        transition: 0.3s;
        box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
        position: relative;
        overflow: hidden;
    }

    #rage-meter::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
            90deg,
            transparent 0%,
            rgba(255, 255, 255, 0.2) 50%,
            transparent 100%
        );
        animation: rageGlow 2s ease-in-out infinite;
    }

    @keyframes rageGlow {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }

    small {
        display: block;
        margin-top: 8px;
        opacity: 0.8;
        font-size: 0.9em;
    }

    /* Add content section styles */
    .content-section {
        display: none;
    }

    .content-section.active {
        display: block;
    }

    /* Update the chat window styles */
    .chat-window {
        position: fixed;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 300px;
        height: auto; /* Remove fixed height */
        max-height: 80vh; /* Add max height */
        background: rgba(0, 0, 0, 0.8);
        border-radius: 0 15px 15px 0;
        transition: transform 0.3s ease;
        z-index: 100;
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        box-shadow: 5px 0 20px rgba(0, 0, 0, 0.3);
    }

    .chat-window.collapsed {
        transform: translateX(-290px) translateY(-50%);
    }

    .chat-content {
        padding: 15px;
        height: 500px; /* Increase height */
        max-height: calc(80vh - 30px);
        display: flex;
        flex-direction: column;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 10px;
        padding-right: 5px;
        padding: 10px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 10px;
    }

    /* Improve chat toggle button */
    .chat-toggle {
        position: absolute;
        right: -40px; /* Increase width */
        top: 50%;
        transform: translateY(-50%);
        width: 40px; /* Increase width */
        height: 80px; /* Increase height */
        background: rgba(0, 0, 0, 0.8);
        border-radius: 0 10px 10px 0;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-left: none;
        box-shadow: 5px 0 10px rgba(0, 0, 0, 0.2);
    }

    .chat-toggle::after {
        content: 'â†’';
        color: #00ff9d;
        font-size: 24px; /* Increase size */
        transition: transform 0.3s;
    }

    /* Improve chat input styling */
    .chat-input {
        display: flex;
        gap: 8px;
        padding: 10px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 10px;
        margin-top: 10px;
    }

    .chat-input input {
        flex: 1;
        padding: 10px;
        border-radius: 5px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(0, 0, 0, 0.2);
        color: #fff;
        font-size: 14px;
    }

    .chat-input button {
        padding: 10px 20px;
        border-radius: 5px;
        border: none;
        background: #00ff9d;
        color: #1a1a2e;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: bold;
    }

    .chat-input button:hover {
        background: #00cc7d;
        transform: translateY(-2px);
    }

    /* Add new mobile sidebar styles */
    .mobile-sidebar {
        position: fixed;
        top: 0;
        left: -280px;
        width: 280px;
        height: 100vh;
        background: rgba(0, 0, 0, 0.95);
        backdrop-filter: blur(10px);
        z-index: 2000;
        transition: left 0.3s ease;
        box-shadow: 5px 0 15px rgba(0, 0, 0, 0.5);
        display: none;
    }

    .mobile-sidebar.active {
        left: 0;
    }

    .mobile-sidebar-header {
        padding: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .mobile-sidebar-header h2 {
        color: #00ff9d;
        margin: 0;
        font-size: 1.2em;
    }

    .close-sidebar {
        color: #00ff9d;
        font-size: 24px;
        background: none;
        border: none;
        cursor: pointer;
        padding: 5px;
    }

    .mobile-sidebar-menu {
        padding: 20px;
    }

    .sidebar-item {
        padding: 15px;
        margin-bottom: 10px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        color: #fff;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .sidebar-item i {
        color: #00ff9d;
        font-size: 20px;
    }

    .mobile-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(3px);
        z-index: 1999;
        display: none;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .mobile-overlay.active {
        display: block;
        opacity: 1;
    }

    /* Add hamburger menu button */
    .hamburger-menu {
        position: fixed;
        top: 20px;
        left: 20px;
        background: rgba(0, 0, 0, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 10px;
        z-index: 1500;
        cursor: pointer;
        display: none;
    }

    .hamburger-menu i {
        color: #00ff9d;
        font-size: 24px;
    }

    /* Update mobile-specific styles */
    @media (max-width: 768px) {
        .mobile-sidebar,
        .hamburger-menu {
            display: block;
        }
        
        .game-container {
            margin-top: 60px; /* Add space for hamburger menu */
            padding: 10px;
        }

        .content-section {
            margin-top: 20px;
        }

        /* Ensure chat window is properly positioned in mobile view */
        #chat-section .chat-window {
            position: relative;
            left: 0;
            transform: none;
            width: 100%;
            max-width: 100%;
            border-radius: 10px;
        }

        #chat-section .chat-window.collapsed {
            transform: none;
        }

        #chat-section .chat-toggle {
            display: none;
        }
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>
</head>
<body>
<div id="loading-screen">
    <div class="loading-tv"></div>
    <div class="loading-text">Connecting to Ad Tycoon Network...</div>
    <div id="loading-progress">
        <div id="loading-meter"></div>
    </div>
</div>

<div class="mobile-overlay"></div>
<button class="hamburger-menu">
    <i>â˜°</i>
</button>
<div class="mobile-sidebar">
    <div class="mobile-sidebar-header">
        <h2>Game Menu</h2>
        <button class="close-sidebar">Ã—</button>
    </div>
    <div class="mobile-sidebar-menu">
        <div class="sidebar-item">
            <i>ðŸŽ®</i>
            <span>Game Controls</span>
        </div>
        <div class="sidebar-item">
            <i>âš¡</i>
            <span>Ad Upgrades</span>
        </div>
        <div class="sidebar-item">
            <i>ðŸ’¬</i>
            <span>Game Chat</span>
        </div>
        <div class="sidebar-item">
            <i>ðŸ“Š</i>
            <span>Stats</span>
        </div>
    </div>
</div>

<div class="game-container">
  <h1>Ad Tycoon - Force Them to Watch!</h1>
  
  <!-- Add mobile navigation -->
  <div class="mobile-nav">
    <div class="nav-tab active" data-tab="game">
      <i>ðŸŽ®</i>
      Game
    </div>
    <div class="nav-tab" data-tab="upgrades">
      <i>âš¡</i>
      Ad Upgrades
    </div>
    <div class="nav-tab" data-tab="chat">
      <i>ðŸ’¬</i>
      Game Chat
    </div>
  </div>

  <!-- Wrap existing content in sections -->
  <div class="content-section active" id="game-section">
    <div class="stats">
      <h2>Revenue: $<span id="money">0</span></h2>
      <h3>Revenue per Ad: $<span id="revenue-per-ad">1</span></h3>
      <h3>Viewer Rage:</h3>
      <div id="viewer-rage">
        <div id="rage-meter"></div>
      </div>
    </div>

    <div class="tv-screen">
      <div class="ad" id="current-ad">Welcome to TV!</div>
    </div>
  </div>

  <div class="content-section" id="upgrades-section">
    <div class="controls">
      <div class="upgrade" id="better-ads" data-cost="$50">
        Upgrade Ad Quality<br>
        <small>Increases revenue per ad</small>
      </div>
      <div class="upgrade" id="faster-ads" data-cost="$100">
        Increase Ad Frequency<br>
        <small>Shows ads more often</small>
      </div>
      <div class="upgrade free-upgrade" id="rage-control" data-cost="FREE!">
        Viewer Manipulation<br>
        <small>Reduces viewer rage</small>
      </div>
      <div class="upgrade" id="subliminal" data-cost="$500">
        Subliminal Messages<br>
        <small>Makes ads more effective</small>
      </div>
    </div>
  </div>

  <div class="content-section" id="chat-section">
    <!-- Replace multiplayer container with new chat window -->
    <div class="chat-window collapsed">
        <div class="chat-toggle"></div>
        <div class="chat-content">
            <div class="chat-header">Game Chat</div>
            <div class="chat-messages" id="chat-messages"></div>
            <div class="chat-input">
                <input type="text" id="chat-input" placeholder="Type your message...">
                <button id="send-button">Send</button>
            </div>
        </div>
    </div>
  </div>
</div>

<script>
const game = {
  money: 0,
  revenuePerAd: 1,
  adInterval: 3000,
  rageIncrease: 3,
  rageDecrease: 1,
  rage: 0,
  subliminalBonus: 1,
  freeRageControlUsed: false,
  
  ads: [
    "Buy our amazing product!",
    "Limited time offer!",
    "You won't believe these prices!",
    "Act now while supplies last!",
    "Don't miss out!",
    "New and improved formula!",
    "9 out of 10 doctors recommend!",
    "The best thing since sliced bread!",
    "Revolutionary breakthrough!",
    "As seen on TV!",
    "Satisfaction guaranteed!",
    "Buy one, get one free!",
    "Results may vary!",
    "Order now and save!",
    "Clinically proven results!",
    "Join millions of satisfied customers!",
    "Experience the difference!",
    "Change your life today!",
    "Better than the competition!",
    "Premium quality guaranteed!"
  ],

  formatNumber(num) {
    const suffixes = ['', 'K', 'M', 'B', 'T', 'Qa', 'Qi', 'Sx'];
    let suffixIndex = 0;
    while (num >= 1000 && suffixIndex < suffixes.length - 1) {
      num /= 1000;
      suffixIndex++;
    }
    return suffixIndex === 0 ? Math.floor(num) : num.toFixed(1) + suffixes[suffixIndex];
  },

  async gameInit() {
    const loadingMeter = document.getElementById('loading-meter');
    const loadingScreen = document.getElementById('loading-screen');
    const gameContainer = document.querySelector('.game-container');
    
    // Simulate loading progress
    let progress = 0;
    const loadingInterval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 100) progress = 100;
        loadingMeter.style.width = `${progress}%`;
    }, 200);

    try {
        // Initialize core game systems
        this.loadGame();
        await this.multiplayerSetup();
        
        // Complete loading
        clearInterval(loadingInterval);
        loadingMeter.style.width = '100%';
        
        // Show game after short delay
        setTimeout(() => {
            loadingScreen.classList.add('hidden');
            gameContainer.classList.add('visible');
            
            // Initialize remaining game systems
            this.updateDisplay();
            this.startAdCycle();
            this.startRageCycle();
            this.setupUpgrades();
            this.startAutoSave();
            this.mobileInit(); // Initialize mobile navigation
        }, 1000);
    } catch (err) {
        console.error('Game initialization error:', err);
        alert('Failed to initialize game. Please refresh the page.');
    }
},

  saveGame() {
    const saveData = {
      money: this.money,
      revenuePerAd: this.revenuePerAd,
      adInterval: this.adInterval,
      rageIncrease: this.rageIncrease,
      rageDecrease: this.rageDecrease,
      rage: this.rage,
      subliminalBonus: this.subliminalBonus,
      freeRageControlUsed: this.freeRageControlUsed
    };
    localStorage.setItem('adTycoonSave', JSON.stringify(saveData));
  },

  loadGame() {
    const savedData = localStorage.getItem('adTycoonSave');
    if (savedData) {
      const data = JSON.parse(savedData);
      Object.assign(this, data);
      
      const rageControl = document.getElementById('rage-control');
      if (this.freeRageControlUsed) {
        rageControl.classList.remove('free-upgrade');
        rageControl.innerHTML = 'Viewer Manipulation ($200)<br><small>Reduces viewer rage</small>';
      }
    }
  },

  startAutoSave() {
    setInterval(() => this.saveGame(), 30000);
  },

  showAd() {
    const adElement = document.getElementById('current-ad');
    const randomAd = this.ads[Math.floor(Math.random() * this.ads.length)];
    adElement.style.animation = 'none';
    adElement.offsetHeight;
    adElement.style.animation = null;
    adElement.textContent = randomAd;
    
    this.money += this.revenuePerAd * this.subliminalBonus;
    this.rage += this.rageIncrease;
    this.updateDisplay();
  },

  startAdCycle() {
    if (this.adCycleInterval) {
      clearInterval(this.adCycleInterval);
    }
    this.adCycleInterval = setInterval(() => this.showAd(), this.adInterval);
  },

  startRageCycle() {
    setInterval(() => {
      this.rage = Math.max(0, this.rage - this.rageDecrease);
      this.updateDisplay();
    }, 1000);
  },

  updateDisplay() {
    document.getElementById('money').textContent = this.formatNumber(this.money);
    document.getElementById('revenue-per-ad').textContent = this.formatNumber(this.revenuePerAd * this.subliminalBonus);
    document.getElementById('rage-meter').style.width = `${Math.min(100, this.rage)}%`;
    
    const upgrades = {
      'better-ads': 50,
      'faster-ads': 100,
      'subliminal': 500
    };

    for (const [id, cost] of Object.entries(upgrades)) {
      const element = document.getElementById(id);
      if (this.money < cost) {
        element.classList.add('disabled');
      } else {
        element.classList.remove('disabled');
      }
    }

    const rageControl = document.getElementById('rage-control');
    if (this.freeRageControlUsed && this.money < 200) {
      rageControl.classList.add('disabled');
    } else {
      rageControl.classList.remove('disabled');
    }

    if (this.rage >= 100) {
      alert('Your viewers have had enough! Game Over!');
      localStorage.removeItem('adTycoonSave');
      location.reload();
    }
  },

  setupUpgrades() {
    document.getElementById('better-ads').onclick = (event) => {
      if (this.money >= 50 && !event.currentTarget.classList.contains('disabled')) {
        this.money -= 50;
        this.revenuePerAd += 1;
        this.updateDisplay();
      }
    };

    document.getElementById('faster-ads').onclick = (event) => {
      if (this.money >= 100 && !event.currentTarget.classList.contains('disabled')) {
        this.money -= 100;
        this.adInterval = Math.max(1000, this.adInterval - 500);
        this.startAdCycle();
        this.updateDisplay();
      }
    };

    document.getElementById('rage-control').onclick = (event) => {
      if (!this.freeRageControlUsed) {
        this.rageDecrease += 0.5;
        this.freeRageControlUsed = true;
        this.updateDisplay();
      } else if (this.money >= 200 && !event.currentTarget.classList.contains('disabled')) {
        this.money -= 200;
        this.rageDecrease += 0.5;
        this.updateDisplay();
      }
    };

    document.getElementById('subliminal').onclick = (event) => {
      if (this.money >= 500 && !event.currentTarget.classList.contains('disabled')) {
        this.money -= 500;
        this.subliminalBonus *= 1.5;
        this.updateDisplay();
      }
    };
  },

  multiplayerSetup() {
    return new Promise((resolve) => {
        try {
            this.peer = new Peer({
                host: '0.peerjs.com',
                secure: true,
                port: 443,
                debug: 2
            });
            
            this.connections = new Set();
            
            this.peer.on('open', (id) => {
                // Only try to add chat message if chat system is initialized
                if (document.getElementById('chat-messages')) {
                    this.addChatMessage('System', 'Connected to chat server');
                }
                // Only setup chat window if elements exist
                if (document.querySelector('.chat-window')) {
                    this.setupChatWindow();
                }
                resolve();
            });

            this.peer.on('connection', (conn) => {
                this.handleConnection(conn);
            });

            this.peer.on('error', (err) => {
                console.error('PeerJS error:', err);
                if (document.getElementById('chat-messages')) {
                    this.addChatMessage('System', 'Connection error occurred');
                }
            });
        } catch (error) {
            console.error('Error in multiplayerSetup:', error);
            resolve(); // Resolve anyway to not block game initialization
        }
    });
},

  setupChatWindow() {
    try {
        const chatWindow = document.querySelector('.chat-window');
        const chatToggle = document.querySelector('.chat-toggle');
        const sendButton = document.getElementById('send-button');
        const chatInput = document.getElementById('chat-input');

        // Only setup events if elements exist
        if (chatWindow && chatToggle) {
            chatToggle.addEventListener('click', () => {
                chatWindow.classList.toggle('collapsed');
            });
        }

        if (sendButton && chatInput) {
            sendButton.addEventListener('click', () => this.sendChatMessage());
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    this.sendChatMessage();
                }
            });
        }
    } catch (error) {
        console.error('Error in setupChatWindow:', error);
    }
},

  sendChatMessage() {
    try {
        const input = document.getElementById('chat-input');
        if (!input) return;

        const message = input.value.trim();
        
        if (message && this.connections.size > 0) {
            const data = {
                type: 'chat',
                peer: this.peer.id,
                message: message
            };
            
            this.connections.forEach(conn => {
                conn.send(data);
            });
            
            this.addChatMessage('You', message);
            input.value = '';
        }
    } catch (error) {
        console.error('Error in sendChatMessage:', error);
    }
},

  addChatMessage(sender, message) {
    try {
        const chatMessages = document.getElementById('chat-messages');
        if (!chatMessages) return;

        const messageDiv = document.createElement('div');
        messageDiv.className = 'chat-message';
        messageDiv.textContent = `${sender}: ${message}`;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    } catch (error) {
        console.error('Error in addChatMessage:', error);
    }
},

  mobileInit() {
    try {
        if (window.innerWidth <= 768) {
            const hamburgerMenu = document.querySelector('.hamburger-menu');
            const mobileSidebar = document.querySelector('.mobile-sidebar');
            const closeButton = document.querySelector('.close-sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            
            if (!hamburgerMenu || !mobileSidebar || !closeButton || !overlay) {
                console.warn('Mobile elements not found');
                return;
            }
            
            const toggleSidebar = () => {
                mobileSidebar.classList.toggle('active');
                overlay.classList.toggle('active');
            };
            
            hamburgerMenu.addEventListener('click', toggleSidebar);
            closeButton.addEventListener('click', toggleSidebar);
            overlay.addEventListener('click', toggleSidebar);
            
            // Handle sidebar menu items
            const sidebarItems = document.querySelectorAll('.sidebar-item');
            sidebarItems.forEach(item => {
                item.addEventListener('click', () => {
                    const spanElement = item.querySelector('span');
                    if (!spanElement) return;
                    
                    const sectionType = spanElement.textContent.toLowerCase().replace(/\s+/g, '-');
                    
                    // Hide all sections
                    document.querySelectorAll('.content-section').forEach(section => {
                        section.classList.remove('active');
                    });
                    
                    // Show selected section
                    const sections = {
                        'ad-upgrades': 'upgrades-section',
                        'game-chat': 'chat-section',
                        'game-controls': 'game-section'
                    };
                    
                    const targetSection = document.getElementById(sections[sectionType]);
                    if (targetSection) {
                        targetSection.classList.add('active');
                    }
                    
                    // Close sidebar
                    mobileSidebar.classList.remove('active');
                    overlay.classList.remove('active');
                });
            });
        }
    } catch (error) {
        console.error('Error in mobileInit:', error);
    }
}
};

game.gameInit();
</script>
</body></html>
